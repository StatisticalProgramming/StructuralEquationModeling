---
title: "Measurement Model Scaling and Identification"
author: "William Murrah"
date: ''
output:
  html_document:
    fig_height: 3
    fig_width: 5
  pdf_document:
    fig_height: 3
    fig_width: 5
  word_document:
    fig_height: 3
    fig_width: 5
---


```{r, include=FALSE}
# Don't delete this chunk if you are using the mosaic package
# This loads the mosaic and dplyr packages
require(mosaic)
```

```{r, include=FALSE}
# Some customization.  You can alter or delete as desired (if you know what you are doing).

# This changes the default colors in lattice plots.
trellis.par.set(theme=theme.mosaic())  

# knitr settings to control how R chunks work.
require(knitr)
opts_knit$set(root.dir ="../../../../")
opts_chunk$set(
  echo = FALSE,
  comment = NULL,
  tidy=FALSE,     # display code as typed
  size="small"    # slightly smaller font for code
)
# This loads the mosaic data sets.  (Could be deleted if you are not using them.)
require(mosaicData)  
require(lavaan)
require(ztable)
options(ztable.type = 'html', ztable.zebra.color="platinum")
library(DiagrammeR)
```


## Conventional Drawing and Labeling of SEM Model

```{r}
grViz("
digraph Basic {
node [shape = circle]
Construct_1;
Construct_2;
node [shape = box]
indicator_1; indicator_2; indicator_3;
indicator_4; indicator_5; indicator_6;
# Edges
Construct_1 -> indicator_1 [label = <&nbsp;&lambda;<sub>1,1</sub>>];
Construct_1 -> indicator_2 [label = <&nbsp;&lambda;<sub>2,1</sub>>];
Construct_1 -> indicator_3 [label = <&nbsp;&lambda;<sub>3,1</sub>>];
Construct_1:n -> Construct_1:n [dir=both, label = <&psi;<sub>1,1</sub>>];

indicator_1:s -> indicator_1:s [dir=both, label = <&theta;<sub>1,1</sub>>];
indicator_2:s -> indicator_2:s [dir=both, label = <&theta;<sub>2,2</sub>>];
indicator_3:s -> indicator_3:s [dir=both, label = <&theta;<sub>3,3</sub>>];

Construct_2 -> indicator_4 [label = <&nbsp;&lambda;<sub>1,2</sub>>];
Construct_2 -> indicator_5 [label = <&nbsp;&lambda;<sub>2,2</sub>>];
Construct_2 -> indicator_6 [label = <&nbsp;&lambda;<sub>3,2</sub>>];
Construct_2:n -> Construct_2:n [dir=both, label = <&psi;<sub>2,2</sub>>];

indicator_4:s -> indicator_4:s [dir=both, label = <&theta;<sub>4,4</sub>>];
indicator_5:s -> indicator_5:s [dir=both, label = <&theta;<sub>5,5</sub>>];
indicator_6:s -> indicator_6:s [dir=both, label = <&theta;<sub>6,6</sub>>];

Construct_1:n -> Construct_2:n [dir=both, label = <&psi;<sub>2,1</sub>>];

{rank = same; Construct_1; Construct_2}
{rank = same; indicator_1; indicator_2; indicator_3; 
indicator_4; indicator_5; indicator_6;}
}  
")

```
\[ \textbf{$\Sigma$} = \left[ \begin{array}{cccccc}
\sigma_{1,1}^2 & \sigma_{1,2} & \sigma_{1,3} & \sigma_{1,4} & \sigma_{1,5} & \sigma_{1,6} \\
\sigma_{2,1} & \sigma_{2,2}^2 & \sigma_{2,3} & \sigma_{2,4} & \sigma_{2,5} & \sigma_{2,6} \\
\sigma_{3,1} & \sigma_{3,2} & \sigma_{3,3}^2 & \sigma_{3,4} & \sigma_{3,5} & \sigma_{3,6} \\
\sigma_{4,1} & \sigma_{4,2} & \sigma_{4,3} & \sigma_{4,4}^2 &  \sigma_{4,5} & \sigma_{4,6} \\
\sigma_{5,1} & \sigma_{5,2} & \sigma_{5,3} & \sigma_{5,4} & \sigma_{5,5}^2 & \sigma_{5,6} \\
\sigma_{6,1} & \sigma_{6,2} & \sigma_{6,3} & \sigma_{6,4} & \sigma_{6,5} & \sigma_{6,6}^2 
\end{array} \right],\] 

\[ \textbf{$\Lambda$} = \left[ \begin{array}{cc}
\lambda_{1,1} & \lambda_{1,2} \\
\lambda_{2,1} & \lambda_{2,2} \\
\lambda_{3,1} & \lambda_{3,2}
\end{array} \right],\] 

\[ \textbf{$\Psi$} = \left[ \begin{array}{cc}
\psi_{1,1} & \psi_{1,2} \\
\psi_{2,1} & \psi_{2,2}
\end{array} \right],\] 

\[ \textbf{$\Lambda^\prime$} = \left[ \begin{array}{cc}
\lambda_{1,1} & \lambda_{2,1} & \lambda_{3,1} \\
\lambda_{1,2} & \lambda_{2,2} & \lambda_{3,2}
\end{array} \right],\] 

\[ \textbf{$\Theta$} = \left[ \begin{array}{cccccc}
\theta_{1,1} & 0 & 0 & 0 & 0 & 0 \\
0 & \theta_{2,2} & 0 & 0 & 0 & 0 \\
0 & 0 & \theta_{3,3} & 0 & 0 & 0 \\
0 & 0 & 0 & \theta_{4,4} &  0 & 0 \\
0 & 0 & 0 & 0 & \theta_{5,5} & 0 \\
0 & 0 & 0 & 0 & 0 & \theta_{6,6} 
\end{array} \right].\] 

### Fundamental SEM equation

$$
\Sigma = \Lambda \Psi \Lambda + \Theta \tag{1}
$$

## 
```{r, echo = TRUE}
library(lavaan)

##Prepare data with sufficient statisitics##
mymeans<-matrix(c(3.06893, 2.92590, 3.11013), ncol=3,nrow=1)
mysd<-c(0.84194,0.88934,0.83470)
mat <- c(1.00000,
         0.55226, 1.00000,
         0.56256, 0.66307, 1.00000)
mycor <- getCov(mat, lower = TRUE)
##Transform correlation matrix to covariance matrix using information above##
myvarcov <- outer(mysd, mysd, FUN="*")
mycov <- mycor * myvarcov

rownames(mycor) <-c( "Glad", "Cheerful", "Happy")
colnames(mycor) <-c( "Glad", "Cheerful", "Happy")

rownames(mycov) <-c( "Glad", "Cheerful", "Happy")
colnames(mycov) <-c( "Glad", "Cheerful", "Happy")
mynob<-823
```


```{r, results = 'asis'}
cr <- ztable(mycor, zebra = 2)
tab <- data.frame(Mean = round(mymeans[1, ], 3), SD = round(mysd, 3), 
                  Var = round(mysd*mysd, 3))

pt <- t(cbind(mycor, tab))
ztable(pt, zebra = 2, caption = "Descriptive Statistics")

```



### Latent Cheer with one indicator

```{r}

```

```
# Mplus file
l.cheer.inp
```
```{r}
grViz("
digraph Cheer {

node [shape = circle]
Positive;

node [shape = box]
Cheer;

# Edges

Positive -> Cheer [label = <&nbsp;&lambda;>];
Positive:n -> Positive:n [dir=both, label = <&psi;>,position = N];
Cheer:s -> Cheer:s [dir=both, label = <&theta;>];
}  
")
```


### Measurement Model: 3 indicators

 using correlations only (instead of variance/covariance matirx)

```{r}
mod1<-'Positive =~ 1*Cheerful
Positive~~Positive
Cheerful~~0*Cheerful'
#Save output to fit1##
fit1<-cfa(mod1, sample.cov=mycov, sample.nobs = mynob, sample.mean=mymeans, 
          std.lv=F)

##Request for summary of output##


summary(fit1, fit.measures=T)
```

```{r, echo = TRUE}
cat(file = 'topics/2_MeasurementModel/2b_ConfirmatoryFactorAnalysis/mplus/l.cheer.out')

```

```{r}
grViz("
    
digraph CFA {

node [shape = circle]
Positive;

node [shape = box]
Glad; Cheer; Happy;

# Edges
Positive -> Glad [label = <&nbsp;&lambda;<sub>1</sub>>];
Positive -> Cheer [label = <&nbsp;&lambda;<sub>2</sub>>];
Positive -> Happy [label = <&nbsp;&lambda;<sub>3</sub>>];
Positive:n -> Positive:n [dir=both, label = <&psi;>]
Glad:s -> Glad:s [dir=both, label = <&theta;<sub>1</sub>>]
Cheer:s -> Cheer:s [dir=both, label = <&theta;<sub>2</sub>>]
Happy:s -> Happy:s [dir=both, label = <&theta;<sub>3</sub>>]

	{rank = same; Positive;}
	{rank = same; Glad; Cheer; Happy;}
}  
")

```


```{r}
mod <- '
Positive =~ Glad + Cheerful + Happy
'

fit <- cfa(mod, sample.cov=mycov, sample.nobs = mynob, sample.mean=mymeans, 
          std.lv=F)
summary(fit)

sigma <- 
```

